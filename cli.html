<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Art</title>
    <style>
        canvas {
            border: 1px solid black;
        }
        .color-picker {
            margin-top: 10px;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }

        h2 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h2>Pixel Drawing Canvas</h2>
    <canvas id="canvas" width="500" height="500"></canvas>
    <div class="color-picker">
        <input type="color" id="colorPicker" value="#00FF00" onchange="setColor(this.value)">
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const pixelSize = 5;
        let selectedColor = '#00FF00';
        
        // 색상을 설정하는 함수
        function setColor(color) {
            selectedColor = color;
        }

        let processedCoordinates = new Set();  // 이미 처리된 좌표 추적

        // 서버에서 받은 색칠된 데이터를 처리하여 캔버스에 표시
        function updateCanvasWithColor(x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize); // 픽셀 크기 5x5로 설정
        }

        canvas.addEventListener('click', function(e) {
            let rect = canvas.getBoundingClientRect();
            let x = Math.floor((e.clientX - rect.left) / pixelSize); // 픽셀 격자 사이즈로 조정
            let y = Math.floor((e.clientY - rect.top) / pixelSize) ;
            let coordKey = `${x},${y}`;

            // 좌표가 새로운 경우에만 POST 요청을 보냄
            if (!processedCoordinates.has(coordKey)) {
                fetch('/update-pixel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ x: x, y: y, color: selectedColor })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    // 서버에서 받은 데이터로 캔버스에 색칠
                    updateCanvasWithColor(x, y, selectedColor);
                })
                .catch(error => console.error('Error:', error));

                // 좌표 저장
                processedCoordinates.add(coordKey); 
            }
        });

        // 페이지 로드 시 기존 캔버스 데이터 불러오기 (서버에서 가져온 데이터)
        function loadExistingPixels() {
            fetch('/get-existing-pixels')  // 서버에서 색칠된 픽셀 가져오기
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                data.forEach(pixel => {
                    updateCanvasWithColor(pixel.x, pixel.y, pixel.color);
                    processedCoordinates.add(`${pixel.x},${pixel.y}`);
                });
            })
            .catch(error => console.error('Error loading existing pixels:', error));
        }

        // 페이지가 로드되면 기존 픽셀을 불러옴
        loadExistingPixels();
    </script>
</body>
</html>